{{$showDevHeader := .Development}}
{{$appSettings := .InjectedData.AppSettings}}
{{$userData := .InjectedData.UserData}}

<!DOCTYPE html>
<html>
	<head>
        <title>{{template "html_title_app_name" .}} | Create License</title>

		{{template "html_head" .}}
	</head>
	<body>
		<!-- HEADER -->
		{{template "header-with-btns" .}}

		<main>
			<div class="container" id="createLicense">
				<div class="row justify-content-center">
                    
                    <!-- inputs for creating license -->
                    <div class="col-12 col-md-6 col-lg-5">
                        <div class="card">
                            <div class="card-header">
                                <h5>Create License</h5>
                                {{if and $appSettings.AllowAPIAccess $userData.Administrator}}
                                <div class="card-header-btn">
                                    <button 
                                        class="btn btn-outline-primary btn-sm" 
                                        v-on:click="(showAPIBuilder = !showAPIBuilder); getAPIKeys()"
                                        data-bs-toggle="tooltip"
                                        data-bs-title="Show API example."
                                    >
                                        <i class="fas fa-wrench"></i>
                                    </button>
                                </div>
                                {{end}}
                            </div>
                            <div class="card-body">
                                <form>
                                    <!-- Choose app and keypair. -->
                                    <fieldset>
                                        <div class="form-group">
                                            <label class="form-label">App:</label>
                                            <select class="form-select" v-model.number="appSelectedID" v-on:change="getKeyPairs(), getCustomFields(), setExpireDate()">
                                                <template v-if="!appsRetrieved">
                                                    <option value="0">Loading...</option>
                                                </template>
                                                <template v-else-if="apps.length === 0" v-cloak>
                                                    <option value="0">No apps exist yet.</option>
                                                </template>
                                                <template v-else v-cloak>
                                                    <option value="0" disabled>Please choose.</option>
                                                    <option v-for="(x, index) in apps" :key="index" v-bind:value="x.ID">[[x.Name]]</option>
                                                </template>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label clas="form-label">Key Pair:</label>
                                            <select class="form-select" v-model.number="licenseData.KeyPairID" v-bind:disabled="appSelectedID === 0">
                                                <template v-if="!keyPairsRetrieved">
                                                    <option value="0">Please choose an app first.</option>
                                                </template>
                                                <template v-else-if="keyPairs.length === 0" v-cloak>
                                                    <option value="0">No key pairs exist yet.</option>
                                                </template>
                                                <template v-else v-cloak>
                                                    <option value="0" disabled>Please choose.</option>
                                                    <option v-for="(x, index) in keyPairs" :key="index" v-bind:value="x.ID">[[x.Name]] <span v-if="x.IsDefault">(Default)</span></option>
                                                </template>
                                            </select>
                                        </div>
                                    </fieldset>
                                    <hr class="divider">

                                    <!-- Common fields. -->
                                    <!-- Only enabled after app and keypair are chosen. -->
                                    <fieldset v-bind:disabled="licenseData.KeyPairID === 0">
                                        <div class="form-group">
                                            <label class="form-label">Company Name:</label>
                                            <input class="form-control" type="text" v-model.trim="licenseData.CompanyName">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Contact Name:</label>
                                            <input class="form-control" type="text" v-model.trim="licenseData.ContactName" placeholder="Who requested this license, first and last name.">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Phone Number:</label>
                                            <input class="form-control" type="tel" v-model.trim="licenseData.PhoneNumber" placeholder="The contact's phone number.">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Email:</label>
                                            <input class="form-control" type="email" v-model.trim="licenseData.Email" placeholder="The contact's email address.">
                                        </div>
                                        <div class="form-group">
                                            <!-- "today" plus the app's DaysToExpiration value. -->
                                            <label class="form-label">Expiration Date:</label>
                                            <input class="form-control" type="date" v-model.trim="licenseData.ExpireDate" v-bind:min="todayPlusOne()">
                                        </div>
                                    </fieldset>

                                    <!-- Custom fields -->
                                    <fieldset v-if="fields.length > 0" v-cloak>
                                        <hr class="divider">
    
                                        <!-- GUI depends on field type. -->
                                        <!-- Default for each field is set after fields are retrieved from API call. -->
                                        <template v-for="(f, idx) in fields">
                                            <!-- integer -->
                                            <div v-if="f.Type === customFieldTypeInteger" v-bind:data-customfielddefinedID="f.ID">
                                                <div class="form-group mb-3">
                                                    <label class="form-label">
                                                        <span class="field-name">[[f.Name]]: </span>
                                                        <span 
                                                            class="field-instructions text-secondary help-icon" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-title="f.Instructions"
                                                            v-if="f.Instructions.length > 0"
                                                            v-cloak
                                                        >
                                                            <i class="fa-solid fa-question-circle"></i>
                                                        </span>
                                                    </label>
                                                    <input 
                                                        class="form-control" 
                                                        type="number" 
                                                        step="1" 
                                                        v-bind:min="f.NumberMinValue" 
                                                        v-bind:max="f.NumberMaxValue" 
                                                        v-model.number="f.IntegerValue" 
                                                        v-bind:data-default="f.IntegerDefaultValue"
                                                    >
                                                </div>
                                            </div>
    
                                            <!-- decimal -->
                                            <div v-else-if="f.Type === customFieldTypeDecimal" v-bind:data-customfielddefinedID="f.ID">
                                                <div class="form-group mb-3">
                                                    <label class="form-label">
                                                        <span class="field-name">[[f.Name]]: </span>
                                                        <span 
                                                            class="field-instructions text-secondary help-icon" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-title="f.Instructions"
                                                            v-if="f.Instructions.length > 0"
                                                            v-cloak
                                                        >
                                                            <i class="fa-solid fa-question-circle"></i>
                                                        </span>
                                                    </label>
                                                    <input 
                                                        class="form-control" 
                                                        type="number" 
                                                        step="0.01" 
                                                        v-bind:min="f.NumberMinValue" 
                                                        v-bind:max="f.NumberMaxValue" 
                                                        v-model.number="f.DecimalValue" 
                                                        v-bind:data-default="f.DecimalDefaultValue"
                                                    >
                                                </div>
                                            </div>
                                            
                                            <!-- text -->
                                            <div v-else-if="f.Type === customFieldTypeText" v-bind:data-customfielddefinedID="f.ID">
                                                <div class="form-group mb-3">
                                                    <label class="form-label">
                                                        <span class="field-name">[[f.Name]]: </span>
                                                        <span 
                                                            class="field-instructions text-secondary help-icon" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-title="f.Instructions"
                                                            v-if="f.Instructions.length > 0"
                                                            v-cloak
                                                        >
                                                            <i class="fa-solid fa-question-circle"></i>
                                                        </span>
                                                    </label>
                                                    <input 
                                                        class="form-control" 
                                                        type="text" 
                                                        v-model.trim="f.TextValue" 
                                                        v-bind:data-default="f.TextDefaultValue"
                                                    >
                                                </div>
                                            </div>
                                            
                                            <!-- boolean -->
                                            <div v-else-if="f.Type === customFieldTypeBoolean" v-bind:data-customfielddefinedID="f.ID">
                                                <div class="form-group mb-3">
                                                    <div class="row">
                                                        <label class="form-label col-sm-6">
                                                            <span class="field-name">[[f.Name]]: </span>
                                                            <span 
                                                                class="field-instructions text-secondary help-icon" 
                                                                data-bs-toggle="tooltip" 
                                                                data-bs-title="f.Instructions"
                                                                v-if="f.Instructions.length > 0"
                                                                v-cloak
                                                            >
                                                                <i class="fa-solid fa-question-circle"></i>
                                                            </span>
                                                        </label>
                                                        <div class="col-sm-6 d-flex flex-row-reverse">
                                                            <div class="btn-group" role="group">
                                                                <input class="btn-check" type="radio" v-bind:name="f.Name" v-bind:id="f.Name + '-true'" autocomplete="off" v-model="f.BoolValue" v-bind:value="true">
                                                                <label class="btn btn-secondary" v-bind:for="f.Name + '-true'">Yes</label>
                                                                
                                                                <input class="btn-check" type="radio" v-bind:name="f.Name" v-bind:id="f.Name + '-false'" autocomplete="off" v-model="f.BoolValue" v-bind:value="false">
                                                                <label class="btn btn-secondary" v-bind:for="f.Name + '-false'">No</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
    
                                            <!-- multi choice -->
                                            <div v-else-if="f.Type === customFieldTypeMultiChoice" v-bind:data-customfielddefinedID="f.ID">
                                                <div class="form-group mb-3">
                                                    <label class="form-label">
                                                        <span class="field-name">[[f.Name]]: </span>
                                                        <span 
                                                            class="field-instructions text-secondary help-icon" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-title="f.Instructions"
                                                            v-if="f.Instructions.length > 0"
                                                            v-cloak
                                                        >
                                                            <i class="fa-solid fa-question-circle"></i>
                                                        </span>
                                                    </label>
                                                    <select 
                                                        class="form-select" 
                                                        v-model.trim="f.MultiChoiceValue" 
                                                        v-bind:data-default="f.MultiChoiceDefaultValue"
                                                    >
                                                        <option value="" disabled selected>Please choose.</option>
                                                        <option v-for="m in f.MultiChoiceOptions.split(';')" v-bind:value="m">[[m]]</option>
                                                    </select>
                                                </div>
                                            </div>
    
                                            <!-- date -->
                                            <div v-else-if="f.Type === customFieldTypeDate" v-bind:data-customfielddefinedID="f.ID">
                                                <div class="form-group mb-3">
                                                    <label class="form-label">
                                                        <span class="field-name">[[f.Name]]: </span>
                                                        <span 
                                                            class="field-instructions text-secondary help-icon" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-title="f.Instructions"
                                                            v-if="f.Instructions.length > 0"
                                                            v-cloak
                                                        >
                                                            <i class="fa-solid fa-question-circle"></i>
                                                        </span>
                                                    </label>
                                                    <input 
                                                        class="form-control" 
                                                        type="date" 
                                                        v-model.trim="f.DateValue" 
                                                        v-bind:min="today()" 
                                                        v-bind:data-default="f.DateDefaultIncrement"
                                                    >
                                                </div>
                                            </div>
                                        </template> <!-- end loop through custom fields -->
                                    </fieldset> <!-- end custom fields -->
                                </form>

                                <div class="alert mt-3 mb-0" v-show="msg.length > 0" v-bind:class="msgType" v-cloak>
                                    [[msg]]
                                </div>
                            </div> <!-- end .card-body -->
                            <div class="card-footer">
                                <button class="btn btn-primary" type="button" v-on:click="create" v-bind:disabled="submitting">Create</button>
                            </div>
                        </div> <!-- end .card-->
                    </div> <!-- end .col-->

                    <!-- api request builder. show how to make an api request -->
                    {{if $appSettings.AllowAPIAccess}}
                    <div class="col-12 col-md-6 col-lg-7" v-show="showAPIBuilder" v-cloak>
                        <div class="card">
                            <div class="card-header">
                                <h5>API Example</h5>
                            </div>
                            <div class="card-body">
                                <!-- stuff not in normal create license gui -->
                                <section>
                                    <div class="form-group">
                                        <label class="form-label">API Key:</label>
                                        <select class="form-select" v-model.number="apiKeySelected">
                                            <template v-if="!apiKeysRetrieved">
                                                <option value="">Loading...</option>
                                            </template>
                                            <template v-else-if="apiKeys.length === 0" v-cloak>
                                                <option value="">No API Keys exist yet.</option>
                                            </template>
                                            <template v-else v-cloak>
                                                <option value="" disabled>Please choose.</option>
                                                <option v-for="(x, index) in apiKeys" :key="index" v-bind:value="x.K">[[x.Description]]</option>
                                            </template>
                                        </select>
                                    </div>
                                </section>
                                <hr class="divider">

                                <div class="form-group">
                                    <div class="row">
                                        <label class="form-label col-sm-6">Return License File:</label>
                                        <div class="col-sm-6 d-flex flex-row-reverse">
                                            <div class="btn-group" role="group">
                                                <input class="btn-check" type="radio" name="returnLicenseFile" id="returnLicenseFile-true" autocomplete="off" v-model="returnLicenseFile" v-bind:value="true">
                                                <label class="btn btn-secondary" for="returnLicenseFile-true">Yes</label>
                                                
                                                <input class="btn-check" type="radio" name="returnLicenseFile" id="returnLicenseFile-false" autocomplete="off" v-model="returnLicenseFile" v-bind:value="false">
                                                <label class="btn btn-secondary" for="returnLicenseFile-false">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Button to build the API example from the provided data and chosen API key. -->
                                <div class="form-group">
                                    <div class="d-grid gap-2">
                                        <button class="form-control btn btn-outline-primary" v-on:click="buildAPIExample">Build cURL Request</button>
                                    </div>
                                </div>

                                <!-- Display built API request -->
                                <section>
                                    <div class="form-group">
                                        <textarea class="form-control text-monospace" readonly v-model="apiExample" rows="15" wrap="off"></textarea>
                                    </div>
                                </section>

                                <!-- Help information. -->
                                <section>
                                    <div class="alert alert-info mt-3 mb-0">
                                        <b>Notes:</b>
                                        <ul>
                                            <li>
                                                An <code>appID</code> or <code>keyPairID</code> is required to create a license. If you provide an <code>appID</code>, the default key pair for the app will be used.
                                            </li>
                                            <li>
                                                The <code>fields</code> value is a URL encoded JSON object with each key exactly matching the name of each custom field defined for the app and the value being a valid value for the defined field.
                                            </li>
                                        </ul>
                                    </div>
                                </section>

                                <div class="alert mt-3 mb-0" v-show="apiBuilderMsg.length > 0" v-bind:class="apiBuilderMsgType" v-cloak>
                                    [[apiBuilderMsg]]
                                </div>
                            </div>
                        </div>
                    </div> <!-- end api builder card-->
                    {{end}}

                </div> <!-- end .row -->
            </div> <!-- end .container -->
        </main>

		{{template "footer"}}
		{{template "html_scripts" .}}
	</body>
</html>